# 香橙派AI Pro综合开发笔记 - 4

### 10. 服务器Nginx配置与管理

#### 10.1 概述

Nginx是一个高性能的HTTP和反向代理服务器，在本项目中承担了托管网站（WordPress）的核心任务。在基于ARM架构的香橙派上部署Nginx，需要特别注意其与现有服务（如CasaOS网关）的兼容性与资源协调。

#### 10.2 安装与基础配置

通过包管理器安装Nginx是最佳实践：

```bash
sudo apt update
sudo apt install nginx -y
```

安装后，关键目录结构如下：

- `/etc/nginx/`: 主配置目录。
- `/etc/nginx/nginx.conf`: 主配置文件。
- `/etc/nginx/sites-available/`: 可用站点的配置文件存放处。
- `/etc/nginx/sites-enabled/`: 通过符号链接启用站点的目录。
- `/var/www/html/`: 默认的网站根目录。

#### 10.3 站点配置详解

一个典型站点的配置文件（例如 `/etc/nginx/sites-available/my_site`）包含以下核心部分：

```nginx
server {
    listen 8081; # 指定监听的端口，需避开常用服务端口
    server_name _; # 可填写域名，或下划线表示通配

    root /var/www/my_site; # 网站文件存放的根目录
    index index.php index.html index.htm; # 默认索引文件顺序

    location / {
        try_files $uri $uri/ /index.php?$args; # 对于WordPress等PHP应用的关键规则
    }

    # 处理PHP请求，转发给PHP-FPM进程
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.1-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # 禁止访问隐藏文件（如.htaccess）
    location ~ /\.ht {
        deny all;
    }
}
```

配置完成后，需创建符号链接以启用站点，并测试配置语法：

```bash
sudo ln -s /etc/nginx/sites-available/my_site /etc/nginx/sites-enabled/
sudo nginx -t
```

#### 10.4 常见故障与调试路径

**故障一：Nginx服务启动失败，提示端口绑定错误**

- **现象**：执行 `sudo systemctl start nginx` 失败，日志显示 `bind() to 0.0.0.0:80 failed (98: Unknown error)`。
- **原因分析**：端口被其他应用占用。在已部署CasaOS的环境中，其自带的 `casaos-gateway` 服务会占用80端口。如果Nginx的默认站点或自定义站点也配置为监听80端口，则会发生冲突。
- **解决方案**：
  1. 检查端口占用情况：`sudo netstat -tulpn | grep :80`。确认占用进程。
  2. 为自建网站改用其他未占用端口（如8081、8080等）。编辑站点配置文件，将 `listen` 指令后的端口号修改为选定端口。
  3. 禁用Nginx的默认站点（如果不需要）：`sudo rm /etc/nginx/sites-enabled/default`。
  4. 重启Nginx：`sudo systemctl restart nginx`。

**故障二：Nginx服务启动失败，提示日志文件无法打开**

- **现象**：`sudo nginx -t` 测试通过，但 `sudo systemctl start nginx` 失败。使用 `sudo systemctl status nginx` 查看详细状态，或在日志中发现 `open() “/var/log/nginx/access.log” failed (2: No such file or directory)`。
- **原因分析**：Nginx的日志目录 `/var/log/nginx/` 不存在，或目录权限不正确，导致Nginx进程（通常以 `www-data` 用户运行）无法创建或写入日志文件。
- **解决方案**：
  1. 创建日志目录并设置正确权限：
     ```bash
     sudo mkdir -p /var/log/nginx
     sudo chown -R www-data:www-data /var/log/nginx
     ```
  2. 为防止系统重启后目录再次丢失导致服务异常，可以修改Nginx的systemd服务单元文件，添加启动前检查。使用 `sudo systemctl edit --full nginx.service` 命令，在 `[Service]` 部分的 `ExecStartPre` 之前加入：
     ```ini
     ExecStartPre=/bin/mkdir -p /var/log/nginx
     ExecStartPre=/bin/chown -R www-data:www-data /var/log/nginx
     ```
  3. 重载systemd配置并重启服务：
     ```bash
     sudo systemctl daemon-reload
     sudo systemctl restart nginx
     ```

**故障三：网站访问出现404或502错误**

- **现象**：Nginx服务运行正常，但通过浏览器访问站点时，返回502 Bad Gateway或404 Not Found。
- **原因分析**：
  - **502错误**：通常意味着Nginx无法与后端的PHP处理器（PHP-FPM）通信。可能是PHP-FPM服务未启动，或者Nginx配置中 `fastcgi_pass` 指定的socket路径不正确。
  - **404错误**：通常意味着Nginx找不到请求的文件或索引文件。检查 `root` 指令指向的目录路径是否正确，以及 `index` 指令列出的文件是否存在于该目录中。
- **解决方案**：
  1. 检查PHP-FPM服务状态：`sudo systemctl status php8.1-fpm`。确保其处于 `active (running)` 状态。
  2. 核对Nginx配置中 `fastcgi_pass` 的socket路径是否与PHP-FPM的实际监听路径一致（通常位于 `/run/php/` 目录下）。
  3. 检查网站根目录（`root` 指令）的路径是否存在，以及权限是否正确（应允许 `www-data` 用户读取）。

**故障四：服务重启后，依赖Nginx的服务无法启动**

- **现象**：配置了其他服务（如内网穿透客户端frpc）依赖于Nginx服务，但服务器重启后，这些依赖服务启动失败。
- **原因分析**：Systemd服务间的启动顺序和依赖关系未正确配置，导致frpc在Nginx准备好之前就已启动并尝试连接，从而失败。
- **解决方案**：修改frpc的systemd服务文件（如 `/etc/systemd/system/frpc.service`），在 `[Unit]` 部分明确声明依赖关系。
  ```ini
  [Unit]
  Description=Frpc Client Service
  After=network.target nginx.service # 确保在网络和Nginx服务之后启动
  Wants=nginx.service # 表明希望nginx启动，但不作为强依赖
  # Requires=nginx.service # 谨慎使用强依赖，可能导致循环依赖或启动失败
  ```

  修改后执行 `sudo systemctl daemon-reload` 使配置生效。

#### 10.5 常用维护命令总结

```bash
# 测试配置文件语法（任何修改后必做）
sudo nginx -t

# 重新加载配置（不中断服务）
sudo systemctl reload nginx

# 完全重启服务
sudo systemctl restart nginx

# 查看实时错误日志（调试利器）
sudo tail -f /var/log/nginx/error.log

# 查看当前监听的端口和进程
sudo netstat -tulpn | grep nginx
```

### 11. 域名、内网穿透与外部访问配置

#### 11.1 概述

在本地网络环境中部署的服务器，若需从互联网访问，必须解决两个核心问题：一是将内网IP和端口映射到公网，二是将便于记忆的域名指向该公网地址。本部分涵盖域名解析、内网穿透服务（以ChmlFrp为例）的集成配置。

#### 11.2 域名购买与DNS解析基础

1. **域名注册**：在诸如Namecheap、GoDaddy、阿里云等域名注册商处购买心仪的域名。
2. **DNS解析类型**：
   - **A记录**：将域名直接指向一个IPv4地址。
   - **CNAME记录**：将域名指向另一个域名（别名）。在内网穿透场景中，常被要求将自有域名CNAME到服务商提供的网关域名。
   - **NS记录**：指定由哪个DNS服务器来管理该域名的解析。例如，你可以使用Cloudflare的DNS服务来获得更快的解析速度和安全特性。

#### 11.3 内网穿透服务：ChmlFrp详解

ChmlFrp是一种基于frp协议的内网穿透服务，它通过在具有公网IP的服务器上运行服务端（frps），在用户本地设备上运行客户端（frpc），建立一条加密隧道，将公网流量转发到内网服务。

**核心概念与操作流程：**

1. **注册与实名认证**：访问ChmlFrp官网完成注册。根据中国法规，使用国内节点通常需要进行实名认证。
2. **选择节点**：在控制面板中选择一个服务器节点。选择时需注意：
   - **国内节点**：通常速度较快，但要求映射的域名**必须已完成ICP备案**。
   - **海外节点**：无备案要求，但可能速度稍慢。适合个人测试或使用未备案域名。
3. **创建隧道**：这是核心配置步骤。在“隧道管理”中创建新隧道，需填写：
   - **本地IP**：运行服务的设备在内网中的IP地址（如 `192.168.1.100`）。若frpc客户端与服务在同一设备，可填 `127.0.0.1`。
   - **本地端口**：内网服务实际监听的端口（如Nginx的 `8081`）。
   - **隧道类型**：根据服务选择 `TCP`、`HTTP` 或 `HTTPS`。Web服务通常选择 `HTTP`。
   - **远程端口**：服务商分配的公网访问端口（部分服务商支持自定义，部分自动分配）。
   - **自定义域名**：如果希望使用自己的域名访问，在此处填写（如 `www.yourdomain.com`）。同时，需要在域名DNS设置中添加一条CNAME记录，指向服务商提供的地址（如 `sj.frp.one`）。
4. **配置与启动客户端**：
   - **下载客户端**：根据本地设备的操作系统和架构（如Linux ARM64）下载对应的frpc客户端。
   - **获取配置文件**：在ChmlFrp控制面板的“配置文件”页面，选择对应节点后生成配置文本。
   - **运行客户端**：将配置文本保存为 `frpc.ini`，与frpc可执行文件放在同一目录，并启动客户端。可配置为系统服务以实现开机自启。

#### 11.4 常见故障与调试路径

**故障一：隧道创建成功，但无法通过外网地址访问**

- **现象**：frpc客户端显示隧道“运行中”，但浏览器访问外网地址（域名:端口）超时或连接被拒绝。
- **原因分析**：
  1. **本地服务未运行**：内网端口的服务（如Nginx）没有启动。
  2. **防火墙/安全组策略**：本地服务器的防火墙或云服务商的安全组未放行内网端口。
  3. **节点或端口被封锁**：某些网络环境（如校园网、企业网）可能封锁了特定端口或协议。
  4. **域名解析未生效或错误**：DNS记录配置错误或尚未全球生效（TTL时间）。
- **解决方案**：
  1. **本地验证**：首先确保在内网通过 `http://本地IP:端口` 可以正常访问服务。
  2. **检查服务状态**：确认Nginx/Web服务正在运行并监听正确端口：`sudo netstat -tulpn | grep :端口号`。
  3. **检查防火墙**：临时关闭本地防火墙测试，或添加放行规则。例如使用UFW：`sudo ufw allow 端口号/tcp`。
  4. **检查frpc日志**：查看frpc客户端输出的日志，确认隧道建立无错误。
  5. **验证DNS解析**：在命令行使用 `nslookup 你的域名` 或 `dig 你的域名` 检查解析出的IP是否为ChmlFrp节点的IP。
  6. **更换端口/节点**：尝试更换隧道的外网端口，或切换到另一个服务节点（如从国内节点换到海外节点）。

**故障二：同时运行多个服务（如网盘和网站）时，只有一个能穿透访问**

- **现象**：配置了多条隧道，但只有最新添加的或其中一条能正常工作。
- **原因分析**：frpc的配置文件 `frpc.ini` 中可能只包含了一条隧道的配置，或者多条隧道配置存在冲突。
- **解决方案**：确保 `frpc.ini` 文件正确合并了所有隧道的配置。一个标准的 `frpc.ini` 文件结构如下：
  ```ini
  [common]
  server_addr = chmlfrp.cn # 服务器地址
  server_port = 7000 # 服务端端口
  token = xxxxxxxx # 认证令牌（如有）

  [service1_web] # 第一条隧道，名称唯一
  type = tcp
  local_ip = 127.0.0.1
  local_port = 8081
  remote_port = 50001

  [service2_nextcloud] # 第二条隧道，名称唯一
  type = tcp
  local_ip = 192.168.31.213
  local_port = 8080
  remote_port = 50002
  ```

  每次在控制面板新增隧道并生成新配置后，需要将新生成的 `[隧道名]` 段内容**追加**到本地现有的 `frpc.ini` 文件中，注意**保留且只有一个 `[common]` 段**。

**故障三：使用自有域名访问时，浏览器提示“重定向过多”或跳转到内网IP端口**

- **现象**：通过 `www.yourdomain.com` 访问网站，却被重定向到类似 `192.168.1.100:8081` 的内网地址，导致无法加载。
- **原因分析**：Web应用（如WordPress）在代码或数据库中配置了固定的站点地址（URL），该地址被设置为内网地址。当它接收到来自域名的请求时，仍会按照内网地址生成重定向。
- **解决方案**：
  1. **修改Web应用配置**：对于WordPress，可以通过修改 `wp-config.php` 文件，在数据库连接设置之后添加以下两行来强制使用访问者使用的域名：
     ```php
     define('WP_SITEURL', 'http://' . $_SERVER['HTTP_HOST']);
     define('WP_HOME', 'http://' . $_SERVER['HTTP_HOST']);
     ```
  2. **修改Nginx配置**：在Nginx的站点配置文件中，确保传递给PHP-FPM的环境变量包含正确的 `HTTP_HOST` 和 `SERVER_PORT`，这有助于某些应用识别原始请求。
     ```nginx
     location ~ \.php$ {
         ...
         fastcgi_param HTTP_HOST $host; # 传递原始请求的主机头
         fastcgi_param SERVER_PORT $server_port; # 传递原始请求的端口
     }
     ```

#### 11.5 集成Cloudflare的注意事项

若将域名的DNS解析托管至Cloudflare以利用其CDN和安全服务，在配合内网穿透时需特别注意：

- **代理状态**：在Cloudflare的DNS记录管理页面，为指向内网穿透地址的CNAME记录，应将代理状态设置为 **“仅DNS”（灰色云朵）**。如果开启代理（橙色云朵），Cloudflare会尝试代理和缓存你的流量，这可能与内网穿透隧道不兼容，导致连接失败。
- **HTTPS**：Cloudflare提供灵活的SSL/TLS加密模式。即使你的内网服务是HTTP，也可以通过Cloudflare的“完全”或“灵活”SSL模式，对外提供HTTPS访问。

### 12. WordPress站点部署与管理

#### 12.1 概述

WordPress是一个基于PHP和MySQL的开源内容管理系统（CMS），以其丰富的主题、插件生态和用户友好性著称。在自行托管的服务器上部署WordPress，能获得完全的控制权。本部分详细记录了在ARM架构的香橙派上，通过LEMP（Linux, Nginx, MariaDB, PHP）环境手动部署WordPress的全过程、遇到的典型问题及其解决方案。

#### 12.2 环境准备与部署流程

WordPress运行依赖于PHP和数据库。在Nginx已安装的基础上，需完成以下步骤：

1. **安装PHP及必要扩展**：
   WordPress核心及多数插件需要PHP与MySQL/MariaDB交互，并处理图像。

   ```bash
   sudo apt install php8.1-fpm php8.1-mysql php8.1-curl php8.1-gd php8.1-mbstring php8.1-xml php8.1-xmlrpc php8.1-zip php8.1-opcache -y
   ```

   安装后，确认PHP-FPM服务启动：`sudo systemctl start php8.1-fpm && sudo systemctl enable php8.1-fpm`。
2. **安装并配置MariaDB数据库**：
   MariaDB是MySQL的一个分支，完全兼容。

   ```bash
   sudo apt install mariadb-server -y
   sudo systemctl start mariadb && sudo systemctl enable mariadb
   ```

   运行安全初始化脚本：`sudo mysql_secure_installation`。按提示设置root密码、移除匿名用户、禁止root远程登录等。
3. **为WordPress创建数据库和用户**：
   通过MySQL命令行进行操作。

   ```bash
   sudo mysql -u root -p
   ```

   在MySQL交互界面中执行：

   ```sql
   -- 创建专用数据库，使用推荐字符集
   CREATE DATABASE wordpress_db DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   -- 创建专用用户并设置强密码
   CREATE USER 'wp_user'@'localhost' IDENTIFIED BY 'your_strong_password_here';
   -- 授予该用户对数据库的全部权限
   GRANT ALL PRIVILEGES ON wordpress_db.* TO 'wp_user'@'localhost';
   -- 刷新权限使设置生效
   FLUSH PRIVILEGES;
   -- 退出
   EXIT;
   ```
4. **下载并解压WordPress文件**：
   将文件放置于Nginx站点配置中 `root` 指令指定的目录。

   ```bash
   # 切换到网站根目录，例如 /var/www/your_site
   cd /var/www/your_site
   # 下载最新中文版WordPress压缩包
   sudo wget https://cn.wordpress.org/latest-zh_CN.tar.gz
   # 解压并移除压缩包
   sudo tar -xzvf latest-zh_CN.tar.gz --strip-components=1
   sudo rm latest-zh_CN.tar.gz
   ```
5. **配置Nginx服务器块**：
   如第10部分所述，创建正确的Nginx配置文件是关键。针对WordPress的配置需要包含处理PHP请求以及美化链接（固定链接）的规则。核心 `location ~ \.php$` 块和 `try_files` 指令必须正确。
6. **运行WordPress安装向导**：
   完成上述步骤后，通过浏览器访问你的网站（内网IP:端口或域名）。首次访问将进入著名的“五分钟安装”页面。在此处填写之前创建的数据库信息（数据库名、用户名、密码，主机为 `localhost`），并设置站点标题、管理员账号和密码。

#### 12.3 文件系统权限管理

正确的文件权限对于安全与功能至关重要。WordPress需要向 `wp-content/uploads` 等目录写入文件（如上传的图片、插件）。

1. **推荐的所有权与权限设置**：
   ```bash
   # 将网站目录的所有者设为Web服务器运行用户（通常是www-data）
   sudo chown -R www-data:www-data /var/www/your_site
   # 设置目录权限为755，文件权限为644
   sudo find /var/www/your_site -type d -exec chmod 755 {} \;
   sudo find /var/www/your_site -type f -exec chmod 644 {} \;
   ```
2. **处理上传问题**：
   如果WordPress后台无法上传文件，通常是 `wp-content/uploads` 目录的权限问题。确保该目录对Web服务器用户可写：
   ```bash
   sudo chown -R www-data:www-data /var/www/your_site/wp-content/uploads
   ```

#### 12.4 常见故障与深度调试路径

**故障一：安装页面提示“建立数据库连接时出错”**

- **现象**：访问安装页面时，WordPress显示经典错误信息：“Error establishing a database connection”。
- **原因分析与排查**：
  1. **配置文件未更新**：`wp-config.php` 文件仍为示例模板，其中的数据库连接信息（`DB_NAME`, `DB_USER`, `DB_PASSWORD`）是占位符。
     - **检查**：`sudo cat /var/www/your_site/wp-config.php | grep -A2 “DB_”`。
     - **解决**：使用 `sudo nano` 命令编辑该文件，填入正确的数据库名、用户名和密码。
  2. **数据库凭据错误**：`wp-config.php` 中填写的数据库用户、密码或数据库名与MariaDB中创建的不一致。
     - **验证**：使用配置文件中的信息尝试手动登录：
       ```bash
       mysql -u wp_user -p’your_password’ -D wordpress_db -e “SELECT ‘Success’;”
       ```
     - **解决**：根据验证结果，修正配置文件或在MariaDB中重新创建用户/数据库。
  3. **MariaDB服务未运行**：数据库服务进程未启动。
     - **检查**：`sudo systemctl status mariadb`。
     - **解决**：启动服务 `sudo systemctl start mariadb`。
  4. **数据库主机问题**：在极少数自定义端口的场景，需确认 `DB_HOST` 定义是否正确（默认 `localhost` 即可）。

**故障二：安装后访问站点，页面被重定向到内网IP地址或错误端口**

- **现象**：通过公网域名访问网站，浏览器地址栏却跳转为类似 `http://192.168.1.100:8081` 的内网地址，导致无法加载。
- **原因分析**：此问题被称为“重定向循环”。WordPress在数据库 `wp_options` 表（或 `wp-config.php` 文件）中存储了 `siteurl` 和 `home` 两个选项。如果这些值被设置为内网地址，当用户通过域名访问时，WordPress会尝试将请求重定向到其认为的“正确”地址（即内网地址）。
- **解决方案**：
  1. **首选方案（修改配置文件，一劳永逸）**：
     编辑 `wp-config.php`，在 `require_once(ABSPATH . ‘wp-settings.php’);` 这一行**之前**，添加以下定义：

     ```php
     define(‘WP_SITEURL’, ‘https://’ . $_SERVER[‘HTTP_HOST’]);
     define(‘WP_HOME’, ‘https://’ . $_SERVER[‘HTTP_HOST’]);
     ```

     这两行代码强制WordPress动态地使用当前访问的域名作为站点地址，完美适配内网穿透场景。如果全站使用HTTPS，则协议应为 `https://`。
  2. **辅助方案（修改Nginx配置）**：
     确保Nginx在将请求转发给PHP-FPM时，传递了正确的主机头。在Nginx站点配置的 `location ~ \.php$` 块内检查或添加：

     ```nginx
     fastcgi_param HTTP_HOST $host;
     fastcgi_param SERVER_PORT $server_port;
     ```
  3. **临时方案（修改数据库，若已安装）**：
     如果WordPress已完成安装，可以通过SQL命令直接修改数据库。

     ```bash
     sudo mysql -u root -p wordpress_db
     ```

     ```sql
     UPDATE wp_options SET option_value = ‘https://your-domain.com’ WHERE option_name IN (‘siteurl’, ‘home’);
     ```

**故障三：更新主题、插件或WordPress核心时，提示需要FTP凭据**

- **现象**：在后台尝试更新时，弹出对话框要求输入FTP服务器信息。
- **原因分析**：PHP进程（`www-data` 用户）对WordPress文件系统的**所有者**权限不足。当文件的所有者是另一个用户（例如，通过SFTP上传文件的用户）时，`www-data` 无权直接修改这些文件。
- **解决方案**：
  1. **最佳实践（更改文件所有权）**：如12.3节所述，将整个WordPress目录的所有权递归地授予Web服务器用户。
     ```bash
     sudo chown -R www-data:www-data /var/www/your_site
     ```
  2. **替代方案（修改配置文件）**：在 `wp-config.php` 中添加一行代码，让WordPress使用直接文件系统操作而非FTP。但此方法略逊于更改所有权。
     ```php
     define(‘FS_METHOD’, ‘direct’);
     ```

**故障四：上传文件时提示“由于安全原因，此文件类型不受支持”或其他上传失败**

- **现象**：在媒体库上传图片或其他文件失败。
- **原因分析与排查**：
  1. **PHP上传限制**：PHP默认对上传文件的大小和超时有限制。
     - **检查与修改**：编辑PHP配置文件，例如 `/etc/php/8.1/fpm/php.ini`，修改以下参数后重启 `php8.1-fpm`：
       ```ini
       upload_max_filesize = 64M
       post_max_size = 128M
       max_execution_time = 300
       ```
  2. **目录权限问题**：如12.3节所述，`wp-content/uploads` 目录必须对 `www-data` 用户可写。
  3. **Nginx客户端最大body大小限制**：Nginx也有一个对应的客户端请求体大小限制。
     - **检查与修改**：在Nginx站点配置的 `server` 块或 `http` 块中添加：`client_max_body_size 100M;`，然后重载Nginx。

#### 12.5 安全与维护建议

1. **保持更新**：定期登录后台更新WordPress核心、已安装的主题和插件。这是防范安全漏洞最重要的措施。
2. **使用强密码**：为WordPress管理员账户和数据库用户使用高强度、唯一的密码。
3. **限制登录尝试**：安装如 `Limit Login Attempts Reloaded` 这类插件，防止暴力破解。
4. **定期备份**：备份应包含两部分：
   - **数据库**：使用 `mysqldump` 命令或插件备份。
   - **网站文件**：特别是 `/wp-content/` 目录。
5. **审计插件与主题**：仅从官方仓库或可信来源安装，并及时删除不使用的插件和主题。
6. **配置调试模式**：仅在排查问题时，在 `wp-config.php` 中开启调试模式，问题解决后务必关闭。
   ```php
   // 启用调试日志（不显示给访客）
   define(‘WP_DEBUG’, true);
   define(‘WP_DEBUG_LOG’, true); // 日志将保存在 /wp-content/debug.log
   define(‘WP_DEBUG_DISPLAY’, false); // 重要：不在页面上显示错误
   @ini_set(‘display_errors’, 0);
   ```

通过遵循上述部署流程、理解权限模型并掌握核心问题的调试方法，可以在自建服务器上稳定、安全地运行WordPress网站。这套基于香橙派和LEMP环境的实践，其原理同样适用于其他Linux服务器平台。

[上一篇](3.md)